<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯書籍</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = { theme: { extend: { colors: { wakatake: '#5DAC81', wakatake_dark: '#488c68', chitose: '#316745', sumi: '#303133', rikyu: '#888E7E', gofun: '#fffffc' } } } }
    </script>
    <style>
        body {
            background-color: #f7f6f2;
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            color: #303133;
        }
    </style>
</head>
<body class="font-sans min-h-screen">
    
    <nav class="bg-chitose text-white px-6 py-4 shadow-lg sticky top-0 z-50 border-b border-white/10">
        <div class="container mx-auto flex justify-between items-center">
            <span class="font-bold text-xl tracking-wide flex items-center gap-2"><i class="fas fa-edit"></i> 編輯書籍資料</span>
            <a href="index.html" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition text-sm font-bold flex items-center gap-2 border border-white/20 backdrop-blur-sm shadow-sm hover:shadow-md">
                <i class="fas fa-times"></i> 取消編輯
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-12 flex justify-center">
        <div class="bg-gofun rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden border border-stone-200 relative min-h-[400px]">
            <div id="loadingMsg" class="absolute inset-0 flex items-center justify-center flex-col text-wakatake bg-white/90 z-10"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p class="text-sumi mt-2">正在載入書籍資料...</p></div>
            <form id="editForm" onsubmit="updateBook(event)" class="grid grid-cols-1 md:grid-cols-2 gap-8 p-8 hidden opacity-0 transition-opacity duration-500">
                <div class="col-span-1 md:col-span-2 border-b border-stone-200 pb-4 mb-2 flex justify-between items-end"><h2 class="text-2xl font-bold text-sumi">修改內容</h2><span class="text-xs text-rikyu">上次更新: 即時</span></div>
                <div class="space-y-6">
                    <div><label class="block text-sm font-bold text-rikyu mb-2">ISBN (鎖定)</label><div class="relative"><input name="ISBN" id="isbnField" readonly class="w-full border-stone-200 bg-gray-100 border p-3 rounded-lg text-gray-500 cursor-not-allowed pl-10"><i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i></div></div>
                    <div><label class="block text-sm font-bold text-sumi mb-2">書名</label><input name="Title" id="titleField" required class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition text-sumi"></div>
                    <div><label class="block text-sm font-bold text-sumi mb-2">作者</label><input name="Author" id="authorField" class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition text-sumi"></div>
                    <div><label class="block text-sm font-bold text-sumi mb-2">出版社</label><input name="Publisher" id="pubField" class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition text-sumi"></div>
                </div>
                <div class="space-y-6">
                    <div><label class="block text-sm font-bold text-sumi mb-2">分類</label><div class="relative"><select name="Category" id="catField" class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition appearance-none cursor-pointer text-sumi"></select><div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-rikyu"><i class="fas fa-chevron-down text-xs"></i></div></div></div>
                    <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 shadow-sm"><label class="block text-sm font-bold text-blue-800 mb-2">庫存管理</label><input name="TotalCopies" id="totalField" type="number" min="1" class="w-full border-blue-200 bg-white border p-3 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none transition text-sumi"><div id="borrowInfo" class="mt-2 text-xs font-bold text-blue-600 bg-blue-100 inline-block px-2 py-1 rounded"><i class="fas fa-info-circle"></i> 讀取中...</div></div>
                    <div><label class="block text-sm font-bold text-sumi mb-2">封面網址</label><input name="CoverUrl" id="coverField" class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition text-sumi"></div>
                </div>
                <div class="col-span-1 md:col-span-2 space-y-6">
                    <div><label class="block text-sm font-bold text-sumi mb-2">簡介</label><textarea name="Description" id="descField" rows="5" class="w-full border-stone-200 bg-stone-50 border p-3 rounded-lg focus:ring-2 focus:ring-wakatake focus:bg-white outline-none transition text-sumi"></textarea></div>
                    <button type="submit" class="w-full bg-wakatake text-white py-4 rounded-xl font-bold hover:bg-wakatake_dark text-lg shadow-lg hover:shadow-xl transition transform active:scale-[0.99]"><i class="fas fa-save"></i> 儲存修改</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isbn = urlParams.get('isbn');
        document.addEventListener('DOMContentLoaded', async () => {
            const catSelect = document.getElementById('catField');
            if(typeof CONFIG !== 'undefined' && CONFIG.CATEGORIES) { CONFIG.CATEGORIES.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; catSelect.appendChild(opt); }); }
            if(isbn) { await loadBookData(isbn); } else { alert('無效的 ISBN'); window.location.href = 'index.html'; }
        });
        async function loadBookData(isbn) {
            try {
                const res = await fetch(`${CONFIG.API_URL}/books/${isbn}`); if (!res.ok) throw new Error('API 回應錯誤'); const book = await res.json();
                document.getElementById('isbnField').value = book.ISBN || ''; document.getElementById('titleField').value = book.Title || ''; document.getElementById('authorField').value = book.Author || ''; document.getElementById('pubField').value = book.Publisher || ''; document.getElementById('catField').value = book.Category || '其他'; document.getElementById('totalField').value = book.TotalCopies; document.getElementById('coverField').value = book.CoverUrl || ''; document.getElementById('descField').value = book.Description || '';
                const borrowed = (book.TotalCopies || 0) - (book.AvailableCopies || 0); document.getElementById('borrowInfo').innerHTML = `<i class="fas fa-book-reader"></i> 目前已借出: ${borrowed} 本 (總數不可低於此值)`; document.getElementById('totalField').min = borrowed;
                document.getElementById('loadingMsg').classList.add('hidden'); const form = document.getElementById('editForm'); form.classList.remove('hidden'); setTimeout(() => form.classList.remove('opacity-0'), 50);
            } catch(e) { document.getElementById('loadingMsg').innerHTML = `<span class="text-red-500"><i class="fas fa-exclamation-triangle"></i> 讀取失敗</span>`; }
        }
        async function updateBook(e) { e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries()); if(!confirm('確定要儲存修改嗎？')) return; try { const res = await fetch(`${CONFIG.API_URL}/admin/books/${isbn}`, { method: 'PUT', body: JSON.stringify(data) }); const result = await res.json(); if(res.ok) { alert('修改成功！'); window.location.href = 'index.html'; } else { alert('修改失敗: ' + result.message); } } catch(e) { alert('系統錯誤'); } }
    </script>
</body>
</html>